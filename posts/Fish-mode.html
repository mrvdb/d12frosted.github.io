<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Fish mode for emacs (v2)</title>
<!-- 2015-05-21 Thu 21:15 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Boris Buliga &lt;d12frosted@icloud.com&gt;" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel='stylesheet' type='text/css' href='/css/default.css' />
<link rel='stylesheet' href='/font-awesome/css/font-awesome.min.css'>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
<header>
  <ul class='nav-list'>
    <li class='nav-elem nav-left nav-head'>
      <a href='/'><i class='fa fa-home'></i> d12frosted</a>
    </li>
    <li class='nav-elem nav-left nav-head'>
      <a href='/archive.html'><i class='fa fa-archive'></i> Archive</a>
    </li>
    <li class='nav-elem nav-left nav-head'>
      <a href='/updates.html'><i class='fa fa-refresh'></i> Latest Updates</a>
    </li>
    <li class='nav-elem nav-right'>
      <a href='http://stackoverflow.com/users/3086454/d12frosted'><i class='fa fa-stack-overflow'></i> StackOverflow</a>
    </li>
    <li class='nav-elem nav-right'>
      <a href='https://github.com/d12frosted'><i class='fa fa-github'></i> GitHub</a>
    </li>
  </ul>
</header>
</div>
<div id="content">
<h1 class="title">Fish mode for emacs (v2)</h1>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Update on 20 May 2015, Wednesday</h2>
<div class="outline-text-2" id="text-1">
<p>
Good news everyone, we merged my changes to main package, so go and install latest version from <a href="http://melpa.org/#/fish-mode">MELPA</a>.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Update on 01 May 2015, Friday</h2>
<div class="outline-text-2" id="text-2">
<p>
Indentation rules were improved. So now it works even in most esoteric cases. Also I have stolen syntax highlighting rules from the package that is available on MELPA. Currently working om merging my changes with the default package.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">tl;dr</h2>
<div class="outline-text-2" id="text-3">
<p>
In educational purposes I implemented <code>fish-mode</code> for emacs. It is very simple and still has some problems with indenting complex stuff. But it works in most cases very well. You can grab it <a href="https://github.com/d12frosted/fish-mode">here</a>.
</p>

<p>
In case you have nothing else to do, read further for some details.
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Long story</h2>
<div class="outline-text-2" id="text-4">
<p>
While I was playing with <code>fish</code>, I felt acute shortage of <code>fish-mode</code> for emacs. My needs are modest - syntax highlighting and indentation. So I searched for existing modes and found one that is also available on MELPA. As usual I installed it from <a href="https://github.com/wwwjfy/emacs-fish">git</a> and found that it works not as I expected. Syntax highlighting worked not as I wanted and most importantly - indentation was buggy. Especially for <code>end</code> term. So I checked the code to fix it. But you know, my emacs lisp fu is pretty weak, so I couldn't understand where lies the problem (well, definitely the problem is with <code>fish-indent-line</code> function). So I thought that I could implement my own major mode in educational purposes(yay!).
</p>

<div class="figure">
<img src="../images/1423468417-fish-mode.png">
</div>

<p>
My starting point was tutorial on <a href="http://ergoemacs.org/emacs/elisp_syntax_coloring.html">ergoemacs</a> that was describing how to implement major-mode for syntax highlighting. So pretty quickly I conquered this topic and implemented some very simple highlighting rules. And then started working on indentation functions. Fish language is really easy. In this language only blocks change indentation. Block begins with one of block-opening terms (<code>if</code>, <code>function</code>, <code>while</code>, <code>for</code>, <code>begin</code> and <code>switch</code>). Every block is closed by <code>end</code>. There is only one construction that makes indentation implementation a bit harder - <code>switch-case</code>, because <code>case</code> opens block and closes previous <code>case</code> block if previous one exists. And there is also another special term <code>else</code> that closes <code>if</code> block, but begins new one. So I started pretty straightforward.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">fish-indent-line</span> <span style="color: #7388D6;">()</span>
  <span style="color: #036A07;">"Indent current line"</span>
  <span style="color: #7388D6;">(</span>interactive<span style="color: #7388D6;">)</span>

  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>bobp<span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span>indent-line-to <span style="color: #D0372D;">0</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">(</span>cur-indent<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">save-excursion</span>
        <span style="color: #907373;">(</span>beginning-of-line<span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">cond</span>
         <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">already on line 1, so leave it alone</span>
         <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>eq <span style="color: #80A880;">(</span>what-line-number<span style="color: #80A880;">)</span> <span style="color: #D0372D;">1</span><span style="color: #858580;">)</span>
          <span style="color: #858580;">(</span>setq cur-indent <span style="color: #80A880;">(</span>current-indentation<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>

         <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">found 'end' - need to move back based on level of matching pair</span>
         <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>looking-at <span style="color: #008000;">"[ \t]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">end</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span><span style="color: #858580;">)</span>
          <span style="color: #858580;">(</span>setq cur-indent <span style="color: #80A880;">(</span>fish-get-end-indent<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>

         <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">found 'case' - need to move forth based on matching switch</span>
         <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>looking-at <span style="color: #008000;">"[ \t]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">case</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span><span style="color: #858580;">)</span>
          <span style="color: #858580;">(</span>setq cur-indent <span style="color: #80A880;">(</span>fish-get-case-indent<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>

         <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">found 'else' - like default condition, but also move left</span>
         <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>looking-at <span style="color: #008000;">"[ \t]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">else</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span><span style="color: #858580;">)</span>
          <span style="color: #858580;">(</span>setq cur-indent <span style="color: #80A880;">(</span>- <span style="color: #887070;">(</span>fish-get-normal-indent<span style="color: #887070;">)</span> tab-width<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>

         <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">default case - indent based on previous non-empty line</span>
         <span style="color: #6276BA;">(</span>t
          <span style="color: #858580;">(</span>setq cur-indent <span style="color: #80A880;">(</span>fish-get-normal-indent<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span>&lt; cur-indent <span style="color: #D0372D;">0</span><span style="color: #907373;">)</span> <span style="color: #907373;">(</span>setq cur-indent <span style="color: #D0372D;">0</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>indent-line-to cur-indent<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
So as you can see, indentation function makes just what I described previously. But it also has some performance improvements. For example, <code>else</code> indentation. Ideally, it should search for matching <code>if</code> term and set indentation level of <code>else</code> to the same level as matching <code>if</code>. But <code>else</code> does make sense only if it is inside of matching <code>if</code> block, so we can use current block indentation level and subtract from it <code>tab-width</code>.
</p>

<div class="org-src-container">

<pre class="src src-fish"><span style="color: #0000FF;">if</span> <span style="color: #006FE0;">test</span> <span style="color: #008000;">$</span><span style="color: #BA36A5;">VAR</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">opens 'if' block</span>
  <span style="color: #0000FF;">begin</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">opens 'begin' block</span>
    do_something
  <span style="color: #0000FF;">else</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">doesn't belong to if, because it's inside of 'begin' block</span>
  <span style="color: #0000FF;">end</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">closes 'begin' block - read more to find out why it closes 'begin' and not 'else'</span>
<span style="color: #0000FF;">end</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">closes 'if' block</span>
</pre>
</div>

<p>
I hope that previous example makes it clear, why we don't need to search for matching <code>if</code>. First helper function we should read - <code>fish-get-normal-indent</code>.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">fish-get-normal-indent</span> <span style="color: #7388D6;">()</span>
  <span style="color: #7388D6;">(</span>interactive<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>not-indented t<span style="color: #709870;">)</span> cur-indent<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">while</span> not-indented
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">move up</span>
      <span style="color: #709870;">(</span>forward-line <span style="color: #D0372D;">-1</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span>
       <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">found block-opening term, so increase indentation level by tab-width</span>
       <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>looking-at <span style="color: #008000;">"[ \t]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">if</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">else</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">function</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">while</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">for</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">begin</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">switch</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">case</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span><span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span>setq cur-indent <span style="color: #858580;">(</span>+ <span style="color: #80A880;">(</span>current-indentation<span style="color: #80A880;">)</span> tab-width<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span>setq not-indented nil<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>

       <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">found empty line, so just skip it</span>
       <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>looking-at <span style="color: #008000;">"[ \t]*$"</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>

       <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">default case, so return indentation level of current line</span>
       <span style="color: #907373;">(</span>t
        <span style="color: #6276BA;">(</span>setq cur-indent <span style="color: #858580;">(</span>current-indentation<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span>setq not-indented nil<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    cur-indent<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Nothing special here. This function returns indentation level based on current block. This function makes assumption that previous non-empty line is well-indented. So we move one line up (<code>(forward-line -1)</code>) and when we face block-opening term, return it's indentation level, increased by <code>tab-width</code>. When we face empty line, skip it. In other cases - just return indentation level of current line (not starting, but current).
</p>

<p>
Now let's check <code>case</code> indentation rules.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">fish-get-case-indent</span> <span style="color: #7388D6;">()</span>
  <span style="color: #7388D6;">(</span>interactive<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>not-indented t<span style="color: #709870;">)</span> cur-indent<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">while</span> not-indented
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">move up</span>
      <span style="color: #709870;">(</span>forward-line <span style="color: #D0372D;">-1</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span>
       <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">found 'switch', so increase indentation level by tab-width</span>
       <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>looking-at <span style="color: #008000;">"[ \t]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">switch</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span><span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span>setq cur-indent <span style="color: #858580;">(</span>+ <span style="color: #80A880;">(</span>current-indentation<span style="color: #80A880;">)</span> tab-width<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span>setq not-indented nil<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>

       <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">found another 'case', so return it's indentation level</span>
       <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>looking-at <span style="color: #008000;">"[ \t]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">case</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span><span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span>setq cur-indent <span style="color: #858580;">(</span>current-indentation<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span>setq not-indented nil<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>

       <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">found empty line, so just skip it</span>
       <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>looking-at <span style="color: #008000;">"[ \t]*$"</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>

       <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">default case, so return indentation level of current line minus tab-width</span>
       <span style="color: #907373;">(</span>t
        <span style="color: #6276BA;">(</span>setq cur-indent <span style="color: #858580;">(</span>- <span style="color: #80A880;">(</span>current-indentation<span style="color: #80A880;">)</span> tab-width<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span>setq not-indented nil<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    cur-indent<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
This function has similar pattern as previous one. It also uses previous non-empty line to decide what indentation level to use for current <code>case</code> term and this function also makes an assumption that previous non-empty line is well-indented. As you can see, for <code>case</code> term <code>switch</code> term behaves like block-opening. Next rule says that every <code>case</code> should be in one block. The last rule says that when we face something that not <code>switch</code> and not another <code>case</code>, we should return it's indentation level and subtract <code>tab-width</code> from it.
</p>

<p>
The last and most important for me - <code>end</code> indentation function.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">fish-get-end-indent</span> <span style="color: #7388D6;">()</span>
  <span style="color: #7388D6;">(</span>interactive<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span>cur-indent <span style="color: #709870;">(</span>count-of-ends <span style="color: #D0372D;">1</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">while</span> <span style="color: #709870;">(</span>not <span style="color: #907373;">(</span>eq count-of-ends <span style="color: #D0372D;">0</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">move up</span>
      <span style="color: #709870;">(</span>forward-line <span style="color: #D0372D;">-1</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span>
       <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">found block-opening term, so check if it matches to our end</span>
       <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>looking-at <span style="color: #008000;">"[ \t]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">if</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">function</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">while</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">for</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">begin</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">switch</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span><span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span>setq count-of-ends <span style="color: #858580;">(</span>- count-of-ends <span style="color: #D0372D;">1</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> <span style="color: #858580;">(</span>eq count-of-ends <span style="color: #D0372D;">0</span><span style="color: #858580;">)</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">block-opening term matches, so return it's indentation level</span>
            <span style="color: #858580;">(</span><span style="color: #0000FF;">progn</span> <span style="color: #80A880;">(</span>setq cur-indent <span style="color: #887070;">(</span>current-indentation<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                   <span style="color: #80A880;">(</span>setq pair-not-found nil<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
          <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">block-opening term does not match, so seek further</span>
          <span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>

       <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">found another 'end', so increase count of 'end' terms</span>
       <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>looking-at <span style="color: #008000;">"[ \t]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">end</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span><span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span>setq count-of-ends <span style="color: #858580;">(</span>+ count-of-ends <span style="color: #D0372D;">1</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>

       <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">nothing interesting found, so seek further</span>
       <span style="color: #907373;">(</span>t<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    cur-indent<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
This function searches for matching block opening term and returns it's indentation level. For this purpose we use <code>count-of-ends</code> variable that stores how much <code>end~s are looking for their match. And when this function finds any block opening term, it reduces value of ~count-of-ends</code> by 1. And when this value is <code>0</code> - we found matching pair for <code>end</code> that we want to indent. Also be aware that we don't count <code>else</code> as block opening term, because then we also need to count it as block closing term. Actually you can't be sure if it will improve performance, so that's why I leave <code>else</code> ignored.
</p>

<p>
So <code>fish-get-end-indent</code> function is a bit complicated. Here is a good example that makes it clear.
</p>

<div class="org-src-container">

<pre class="src src-fish"><span style="color: #0000FF;">if</span> <span style="color: #006FE0;">test</span> <span style="color: #008000;">$</span><span style="color: #BA36A5;">ARG</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">open if block</span>
  do_something1
  <span style="color: #0000FF;">begin</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">open begin block</span>
    do_something2
  <span style="color: #0000FF;">end</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">close begin block</span>
<span style="color: #0000FF;">end</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">close if block</span>
</pre>
</div>

<p>
From this example it looks like we could implement <code>end</code> as <code>else</code> - just get current block indentation level and subtract from it <code>tab-width</code>. But here is example that counters this idea.
</p>

<div class="org-src-container">

<pre class="src src-fish"><span style="color: #0000FF;">begin</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">open begin block</span>
  <span style="color: #0000FF;">switch</span> <span style="color: #008000;">$</span><span style="color: #BA36A5;">animal</span>
    <span style="color: #0000FF;">case</span> cat
      <span style="color: #006FE0;">echo</span> evil
    <span style="color: #0000FF;">case</span> wolf dog human moose dolphin whale
      <span style="color: #006FE0;">echo</span> mammal
    <span style="color: #0000FF;">case</span> duck goose albatross
      <span style="color: #006FE0;">echo</span> bird
    <span style="color: #0000FF;">case</span> shark trout stingray
      <span style="color: #006FE0;">echo</span> <span style="color: #006FE0;">fish</span>
    <span style="color: #0000FF;">case</span> <span style="color: #008000;">'*'</span>
      <span style="color: #006FE0;">echo</span> I have no idea what a <span style="color: #008000;">$</span><span style="color: #BA36A5;">animal</span> is
  <span style="color: #0000FF;">end</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">it closes switch block, but we need to subtract tab-width twice</span>
<span style="color: #0000FF;">end</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">closes begin block</span>
</pre>
</div>

<p>
So as you can see, this <code>switch-case</code> makes a lot of trouble. That's why we need to seek for matching pair when we want to indent <code>end</code> term.
</p>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Shut up and give me my mode</h2>
<div class="outline-text-2" id="text-5">
<p>
Feel free to hack my implementation on <a href="https://github.com/d12frosted/fish-mode">github</a>.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p>By Boris Buliga &lt;d12frosted@icloud.com&gt;<p><p>Created on <span class="timestamp-wrapper"><span class="timestamp">&lt;2015-02-09&gt;</span></span><p>
</div>
</body>
</html>
