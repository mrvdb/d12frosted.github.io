<!DOCTYPE html>
<html>
<head>
  <title>d12frosted - Org mode and the publisher's cookies (org + haskyll)</title>
  <meta charset="UTF-8">
  <link href="http://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
  <link href="../css/all.css" rel="stylesheet" type="text/css">
</head>

<body>
  <header>
    <ul class="nav-list">
      <li class="nav-elem nav-left nav-head">
        <a href="../">d12frosted</a>
      </li>
      <li class="nav-elem nav-left ">
        <a href="../archive.html">Archive</a>
      </li>
      <li class="nav-elem nav-right">
        <a href="https://github.com/d12frosted">
          <img src="../images/github-icon.png">
          GitHub
        </a>
      </li>
    </ul>
  </header>

  <main>
    <h1>Org mode and the publisher's cookies (org + haskyll)</h1>

<p>Over the last months I have totally switched to org-mode. For me all started with tracking tasks and todos within emacs. But then I realized that I create <code>.txt</code> and <code>.md</code> no more. And then I realized that I abandoned my lovely <code>KitsuneBook</code>. Can’t say that I am totally happy with it (hey, I’ve lost a great fellow pet project), but <code>org-mode</code> gave me much more in turn. It solved my seemingly never-ending note organization problem, it allowed me to use some neat features right in these regular text files (like references, reminders, code sourcing and editing, tables with formulas, latex, tasks, planning etc). And most important - it suits ideally my emacs-overusing model (probably because org-mode is a mode for emacs, isn’t it?).</p>
<p>When I created my blog I was writing everything in <code>markdown</code>. Recently I found that <code>pandoc</code> (the tool that is used by <code>hakyll</code> to convert markdown files to <code>html</code>) can convert <code>org</code> files to <code>html</code> as well. Well, I am not surprised. So I started to write for this blog in <code>org</code>. But I wanted to tell that I actually had serious problem with duplicating files. You see, I usually create notes in my working directory (say, <code>org-home-path</code> or previously, in <code>kitsunebook</code> home). I write them, update them. And when I decide that I want to share this note - I just copy and paste parts that I want to share into new file in blog repository. And that looks fine until I need to change something in shared note. Then I need to make all modifications in my working directory then copy them to blog. And I can’t just copy the whole file because</p>
<ol>
<li>It contains some information that is not public (like some references, todos, draft parts that I am still probably working on). And while it’s part of my working directory - I can easily search, process and convert this note as I need from everywhere.</li>
<li>I need to add some meta information (like title, tags) that is used by <code>hakyll</code> right into the file. And I hate having this meta information in file that is in my working directory, because it needs to be at the very top of file and I have some useful functions that I am too lazy to make working with this meta info.</li>
</ol>
<p>So honestly I was thinking about moving out from <code>hakyll</code> to any tool that would allows me to create static blog from org files. I found such tools (most interesting from them was <code>o-blog</code>), but I wasn’t satisfied, because I felt like switching from one problematic thing to other. Plus it required to configure too much things. So I decided to give another try to built-in org publishing functions. And I was surprised by results.</p>
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Making the configs</a>
<ul>
<li><a href="#sec-1-1">Few words before (don’t read it)</a></li>
<li><a href="#sec-1-2">Important notice before we start (sorry for delaying!)</a></li>
<li><a href="#sec-1-3">Structure</a></li>
<li><a href="#sec-1-4">What about images?</a></li>
<li><a href="#sec-1-5">Combine it till it combines</a></li>
</ul></li>
<li><a href="#sec-2">In case you’re stuck</a></li>
<li><a href="#sec-3">Some words to defend myself (hello, hakyll)</a></li>
<li><a href="#sec-4">So what?</a></li>
<li><a href="#sec-5">Advertisement (because you don’t poses a premium account)</a></li>
</ul>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Making the configs</h2>
<div id="text-1" class="outline-text-2">
<div class="figure">
<img src="../images/1431366966-org1.png" alt="Leuven making you jealous" />
<p>Leuven making you jealous</p>
</div>
</div>
<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">Few words before (don’t read it)</h3>
<div id="text-1-1" class="outline-text-3">
<p>Whenever I read about org-mode features in manual, I end up googling examples, trying and then returning to manual. With project publishing situation was pretty similar. I’ve read publishing section and then was like: ‘So how do I configure it?’. Then I found some good examples (on org official site) and the understanding came to me. So delightful.</p>
<p>So to the configs.</p>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">Important notice before we start (sorry for delaying!)</h3>
<div id="text-1-2" class="outline-text-3">
<p><code>org-mode</code> is a big package. So a lot of stuff is loaded lazily. When you experiment with publishing configurations you might want to <code>(require 'ox-publish)</code>. Otherwise you’ll face undefined functions until restart.</p>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">Structure</h3>
<div id="text-1-3" class="outline-text-3">
<p>My blog (a bit simplified, avoiding all hakyll-related stuff) has following structure:</p>
<pre class="example"><code>.
├── images
└── posts</code></pre>
<p>Simple, isn’t it? I bet you expected something far more complicated. Even in it’s simplified version. But that’s pretty all I need.</p>
<p>In order to publish projects in <code>org-mode</code> you need to specify your project. Usually (in real life) a project is a combinations of lesser projects. What is a project from <code>org-mode</code> point of view? Well, a bunch of files that matches search criteria with defined ‘publishing’ rules. So it’s a pair of files and their compiler (<code>([FilePath], Compiler)</code>). My <code>posts</code> directory contains only <code>org</code> files, so in my case - there are two projects: one for org-files and one for images. OK, I am joking, there are three of them - the last one is a combination of first two.</p>
<p>Let’s define our first project! Project is configured by specifying property values.</p>
<div class="org-src-container">
<pre class="sourceCode src src-emacs-lisp commonlisp"><code class="sourceCode commonlisp">(<span class="st">&quot;project-name&quot;</span> :property value :property value ...)</code></pre>
</div>
<p>For <code>org</code> files it would be something like:</p>
<div class="org-src-container">
<pre class="sourceCode src src-emacs-lisp commonlisp"><code class="sourceCode commonlisp">(<span class="st">&quot;d12-org-files&quot;</span>
 :base-directory <span class="st">&quot;~/Dropbox/org/d12frosted/posts/&quot;</span>               <span class="co">; directory where org files are stored</span>
 :base-extension <span class="st">&quot;org&quot;</span>                                           <span class="co">; extensions of files you are going to publish</span>
 :publishing-directory <span class="st">&quot;~/Developer/d12frosted.github.io/posts/&quot;</span> <span class="co">; directory where published files are stored</span>
 :publishing-function org-html-publish-to-html                   <span class="co">; function to use for publishing</span>
 :html-extension <span class="st">&quot;html&quot;</span>                                          <span class="co">; extension of resulting files (org -&gt; html)</span>
 :body-only <span class="kw">t</span>                                                    <span class="co">; Only export section between &lt;body&gt; &lt;/body&gt;</span>
 )</code></pre>
</div>
<p>Pretty straightforward. However, few notes. First, you might noticed that for publishing I am using <code>org-html-publish-to-html</code> function. I also asked it to publish <code>body-only</code>. Actually, my first intention was to use <code>org-org-publish-to-org</code> function to generate <code>org</code> files, but I find built-in HTML exporter far more useful in terms of controlling export configurations on per-file bases. I find it much easier to setup some settings in this file than generating few different compilers in <code>hakyll</code>. For more info about publishing functions, read <a href="http://orgmode.org/manual/Publishing-action.html#Publishing-action">manual</a>.</p>
<p>Also you might be interested in <code>recursive</code> property, which makes this function to search for <code>org</code> files recursively (surprise).</p>
<p>So we configured our first project. To make things work we need to put this to <code>org-publish-project-alist</code>.</p>
<div class="org-src-container">
<pre class="sourceCode src src-emacs-lisp commonlisp"><code class="sourceCode commonlisp">(<span class="kw">setq</span> org-publish-project-alist
      '((<span class="st">&quot;d12-org-files&quot;</span>
         :base-directory <span class="st">&quot;~/Dropbox/org/d12frosted/posts/&quot;</span>               <span class="co">; directory where org files are stored</span>
         :base-extension <span class="st">&quot;org&quot;</span>                                           <span class="co">; extension of files you are going to publish</span>
         :publishing-directory <span class="st">&quot;~/Developer/d12frosted.github.io/posts/&quot;</span> <span class="co">; directory where published files are stored</span>
         :publishing-function org-html-publish-to-html                   <span class="co">; function to use for publishing</span>
         :html-extension <span class="st">&quot;html&quot;</span>                                          <span class="co">; extension of resulting files (org -&gt; html)</span>
         :body-only <span class="kw">t</span>                                                    <span class="co">; Only export section between &lt;body&gt; &lt;/body&gt;</span>
         )))</code></pre>
</div>
</div>
</div>
<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4">What about images?</h3>
<div id="text-1-4" class="outline-text-3">
<p>As I told, in my case there are two (three) projects. The second is about images. And here is a truth - <code>base-extension</code> is actually regexp. So you don’t need to create separate projects for every time of images you want to share. For static files (the files that don’t require any conversion / compiling) there is a separate function - <code>org-publish-attachment</code>. Let’s see how I configured this project.</p>
<div class="org-src-container">
<pre class="sourceCode src src-emacs-lisp commonlisp"><code class="sourceCode commonlisp">(<span class="st">&quot;d12-images&quot;</span>
 :base-directory <span class="st">&quot;~/Dropbox/org/d12frosted/images/&quot;</span>               <span class="co">; directory where org files are stored</span>
 :base-extension <span class="st">&quot;png</span>\\<span class="st">|jpg</span>\\<span class="st">|gif&quot;</span>                                <span class="co">; extensions of images</span>
 :publishing-directory <span class="st">&quot;~/Developer/d12frosted.github.io/images/&quot;</span> <span class="co">; directory where to move (publish) images</span>
 :publishing-function org-publish-attachment                      <span class="co">; function to use for publishing</span>
)</code></pre>
</div>
<p>Nothing interesting here.</p>
</div>
</div>
<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5">Combine it till it combines</h3>
<div id="text-1-5" class="outline-text-3">
<p>And the most easiest part. Now we are going to configure a project that combines two previously configured.</p>
<pre class="example"><code>(&quot;d12&quot;
 :components (&quot;d12-org-files&quot;
              &quot;d12-images&quot;))</code></pre>
<p>In my case the parent project is very simple. So again, nothing interesting.</p>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">In case you’re stuck</h2>
<div id="text-2" class="outline-text-2">
<p>To publish current file use <code>C-c C-e P f</code>. To publish current project - <code>C-c C-e P p</code>. To publish all files - <code>C-c C-e P a</code>. But sometimes it will say ‘skipping X file, because it hasn’t changed’. Know this - <code>rm -r ~/.org-timestamps</code>. You can configure the directory of publish timestamps by changing the value of <code>org-publish-timestamp-directory</code>.</p>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Some words to defend myself (hello, hakyll)</h2>
<div id="text-3" class="outline-text-2">
<p>As you see, there is nothing complicated in publishing configurations. Actually you can do much more. When publishing you can also create sitemap (so publishing result looks more like a SITE rather than bunch of unrelated pages). I recommend you to checkout this <a href="http://orgmode.org/worg/org-tutorials/org-publish-html-tutorial.html">tutorial</a> to see what else you can do with publishing in <code>org-mode</code>. For me - these pity configurations is everything I need, because it is passed to <code>hakyll</code>. The only problem you might face - syntax highlighting. The problem is with <code>org-html-src-block</code> function an how <code>pandoc</code> converts <code>code</code> blocks. To make use of <code>pandoc</code> syntax highlighting your code blocks should have a language <code>class</code>. I mean something like:</p>
<div class="org-src-container">
<pre class="sourceCode src src-html html"><code class="sourceCode html"><span class="kw">&lt;code</span><span class="ot"> class=</span><span class="st">&quot;haskell&quot;</span><span class="kw">&gt;</span>applyEvery f n = zipWith ($) (cycle (f : replicate (n-1) id))<span class="kw">&lt;/code&gt;</span></code></pre>
</div>
<p>But <code>org-mode</code> publishes it as</p>
<div class="org-src-container">
<pre class="sourceCode src src-html html"><code class="sourceCode html"><span class="kw">&lt;code</span><span class="ot"> class=</span><span class="st">&quot;src src-haskell&quot;</span><span class="kw">&gt;</span>applyEvery f n = zipWith ($) (cycle (f : replicate (n-1) id))<span class="kw">&lt;/code&gt;</span></code></pre>
</div>
<p>I thought that it’s possible to configure it via some variables, but then I checked the definition of function that is responsible for converting src blocks and found that this behaviour is hard-coded. Probably no one ever required more control on it. So I just redefined it by changing the last <code>format</code> sexp into</p>
<div class="org-src-container">
<pre class="sourceCode src src-emacs-lisp commonlisp"><code class="sourceCode commonlisp">(<span class="kw">format</span> <span class="st">&quot;</span>\n<span class="st">&lt;pre class=</span>\&quot;<span class="st">src src-%s %s</span>\&quot;<span class="st">%s&gt;%s&lt;/pre&gt;&quot;</span> lang lang label code)</code></pre>
</div>
<p>A bit noisy. But I still need to update my <code>css</code> files in order to remove <code>src-haskell</code> and <code>src</code>.</p>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">So what?</h2>
<div id="text-4" class="outline-text-2">
<ol>
<li>All my notes / posts are in one place. So I get all bonuses from org-mode and my configurations for it (like agenda, search etc) - I am tired of repeating them.</li>
<li>I can easily add custom configurations to certain posts (like toc, visibility of different parts, either export todos or not etc).</li>
<li>No duplicates!</li>
<li>Drafts vs Posts. No more agony!</li>
</ol>
<p>I am still thinking about automating publishing process even more. <code>org-mode</code> allows you to call custom function on pre-publishing and post-publishing. So I actually can rebuild my site using <code>hakyll</code>, commit changes and push automatically. But I still want to do it manually. Who knows what awaits me.</p>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Advertisement (because you don’t poses a premium account)</h2>
<div id="text-5" class="outline-text-2">
<p>Hey, checkout my latest <a href="https://github.com/d12frosted/environment/blob/master/emacs/configs/org-configs.el">org-configs.el</a>!</p>
</div>
</div>

<div class="info">
    Posted on May 11, 2015
    
</div>

  </main>

  <footer>
  </footer>
</body>
</html>
